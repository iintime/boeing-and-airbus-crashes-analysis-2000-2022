library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(ggthemes)
library(forcats) 
library(RColorBrewer)

# read csv file
df <- read_csv("Plane Crashes.csv")
# remove duplicate
df_clean <- df[!duplicated(df), ]
# create year column
df_clean$Year <- year(df_clean$Date)

#check
nrow(df_clean)
colnames(df_clean)





#### Question  
### 1.Who is the most accident (all accident)?
# filter for Boeing and Airbus crash (All Reason)
aircrashes_all_reason <- df_clean %>%
  filter(grepl("^Airbus A3", Aircraft) | grepl("^Boeing 7", Aircraft)) %>%
  mutate(Manufacturer = if_else(grepl("^Airbus", Aircraft), "Airbus", "Boeing")) %>%
  filter(Year >= 2000)

aircrashes_all_reason %>%
  count(Manufacturer)
# plot1
ggplot(aircrashes_all_reason, aes(Year, fill=Manufacturer)) +
  geom_bar() +
  ggtitle("Airbus and Boeing Crashed Between 2000-2022") +
  theme_economist() +
  scale_fill_manual(values=c('#43766C', '#6C22A6'))
  
# plot2
# percentage
percentage_manufacturer <-aircrashes_all_reason %>%
  group_by(Manufacturer) %>%
  summarize(counts = n(),
            percentage = n()/nrow(aircrashes_all_reason))

percentage_manufacturer

# Plot Pie Chart
ggplot(percentage_manufacturer, aes(x="", y=percentage, fill=Manufacturer)) +
  theme_economist() +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  geom_text(aes(label = paste0(round(percentage*100), "%")), 
            position = position_stack(vjust = 0.5)) +
  theme(panel.background = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(), 
        plot.title = element_text(hjust = 0.5, size = 18)) +
  ggtitle("Crashed by Manufacturer") 






### 2. Top 5 Aircraft type that has accident
# Boeing
boeing <- aircrashes_all_reason %>%
  filter(grepl("^Boeing 7", Aircraft))

# Airbus
airbus <- aircrashes_all_reason %>%
  filter(grepl("^Airbus A3", Aircraft))

count_type <- head(aircrashes_all_reason %>%
                     select(Aircraft) %>%
                     group_by(Aircraft) %>%
                     summarise(counts = n()) %>%
                     arrange(desc(counts)),5)

count_type %>% 
  select(Aircraft, counts) %>% 
  mutate(Aircraft = fct_reorder(Aircraft, counts)) %>% 
  ggplot(aes(Aircraft, counts, fill=Aircraft)) +
  geom_col() +
  theme_economist() +
  coord_flip() +
  ggtitle("Top 5 Aircraft Type Crashed by Every Reason") +
  scale_fill_manual(values=c('#96E9C6', '#83C0C1', '#37B5B6', '#6962AD', '#6C22A6'))


### 3. Stack bar with reason
crash_cause <- select(aircrashes_all_reason, Manufacturer, `Crash cause`)


ggplot(crash_cause, aes(Manufacturer, fill=`Crash cause`)) +
  geom_bar(position = "fill") +
  theme_economist() +
  ggtitle("Crash Causes") +
  scale_fill_manual(values=c('#96E9C6', '#0F1035', '#37B5B6', '#FF004D', '#FFC436', '#401F71'))




### 4. Percentage of technical Reason in each Manufacturer
# filter for Boeing and Airbus crash (Technical Reason)
aircrashes_technical_reason <- aircrashes_all_reason %>%
  filter(grepl("Technical failure", `Crash cause`))


# percentage
percentage_thechnical_reason <-aircrashes_technical_reason %>%
  group_by(Manufacturer) %>%
  summarize(counts = n(),
            percentage = n()/nrow(aircrashes_technical_reason))

percentage_thechnical_reason

# Plot Pie Chart
ggplot(percentage_thechnical_reason, aes(x="", y=percentage, fill=Manufacturer)) +
  theme_economist() +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  geom_text(aes(label = paste0(round(percentage*100), "%")), 
            position = position_stack(vjust = 0.5)) +
  theme(panel.background = element_blank(),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(), 
        plot.title = element_text(hjust = 0.5, size = 18)) +
  ggtitle("Crashed by Technical Failure") 
